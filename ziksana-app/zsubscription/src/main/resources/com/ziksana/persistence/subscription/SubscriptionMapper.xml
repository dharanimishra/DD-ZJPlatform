<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ziksana.persistence.subscription.SubscriptionMapper">

	<select id="getLearnerNotes" resultMap="notesResultMap"
		parameterType="map">


		select *
		from
		sbnsubscribernotes notes join
		sbnmembersubscriptionprogram program on
		notes.MemSubscriptionProgId=program.MemSubscriptionProgId
		where
		notes.SubscriptionCourseId=#{subscrCourseId} and
		program.MemberRoleId=#{memberRoleId}


	</select>


	<select id="getEducatorNotes" resultMap="notesResultMap"
		parameterType="map">


		
		
		
		select
		cntenr.LinkElement,
		cntenr.LinkDescription as NotesContent

		from
		corcontentenrichment cntenr
		JOIN
		corenrichment enr ON
		cntenr.enrichmentid= enr.enrichmentId
		JOIN
		sbnsubscriptioncourse sbncourse ON
		sbncourse.CurriculumCourseId=enr.CurriculumCourseId
		JOIN
		sbnmembersubscriptionprogram subprgm ON
		sbncourse.MemSubscriptionProgId=subprgm.MemSubscriptionProgId
		where
		cntenr.LinkType = 8
		<if test="subscrCourseId != null">
		AND enr.CourseId=#{subscrCourseId} 
		</if>
		and 
		enr.LearningComponentId=#{learnCompId} and 
		enr.LearningContentId=#{learnCmpContId} and 
		subprgm.MemberRoleId=#{memberRoleId}
		
		
		
		

	</select>


	<select id="getContentByType" resultMap="notesResultMap" parameterType="map">

		select *
		from
		sbnsubscribernotes notes join
		sbnmembersubscriptionprogram program on
		notes.MemSubscriptionProgId=program.MemSubscriptionProgId
		where
		notes.SubscriptionCourseId=#{subscrCourseId} and
		notes.LearningComponentId=#{learnCompId} and 
		notes.LearningComponentContentId=#{learnCmpContId} and 
		program.MemberRoleId=#{memberRoleId} and 
		notes.NotesType=#{noteType}
		
	</select>



	<insert id="addNote" parameterType="com.ziksana.domain.course.subscription.Note"
		useGeneratedKeys="true" keyProperty="SubcribeNotesId">

		insert into
		sbnsubscribernotes(CreationDate,NotesType,NotesContent,SubscriptionCourseId,LearningComponentId,LearningComponentContentId,MemSubscriptionProgId)
		values(now(), #{type},#{content},
		(select subscriptioncourseid
		from
		sbnsubscriptioncourse subcourse,corcurriculumcourse curcourse
		where
		subcourse.CurriculumCourseId=curcourse.CurriculumCourseId and
		curcourse.CourseId=#{courseId}),
		#{learnCompId},
		#{learnCmpContId},
		(select
		memsubscriptionprogid
		from
		sbnmembersubscriptionprogram
		where
		memberroleid=#{memberRoleId})
		)



	</insert>




	<resultMap id="notesResultMap" type="com.ziksana.domain.course.EducatorNote">

		<result property="title" column="LinkElement" />
		<result property="description" column="NotesContent" />

	</resultMap>

</mapper>